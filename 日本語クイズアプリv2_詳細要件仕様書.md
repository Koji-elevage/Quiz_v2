# 日本語クイズアプリ v2 詳細要件仕様書

最終更新日: 2026-03-01
対象: 授業連動型語学クイズアプリ「日本語クイズ」 v2 アップデート

## 0. 役割定義
- `Admin = Owner`: システム管理権限（User追加/削除）
- `Teacher = User`: 問題作成・編集・配布
- `Student`: クイズ受験者

## 1. 目的とスコープ
- 学習者のモチベーション向上を目的に、進捗バー、クリア時のアニメーション（紙吹雪など）を導入する。
- **データ構造の拡張**: UIの充実に伴い、DBに保存するJSON構造（`questions_json`）を拡張する。
- **アーキテクチャの分離**: V2のプロトタイプUI（1ファイル）を、V1同様に「Teacher/User画面」「Student画面」「サーバー/DB」に分割・統合する。
- **運用導線の明確化**: Studentの正規導線は「Teacher/User配布のQR（`/quiz/:id`）」とし、トップ（`/`）は説明ページとして扱う。
- **管理系保護**: 管理系APIはAdmin/OwnerまたはTeacher/User認証を必須にする（既定はGoogleログイン、互換としてトークン方式も可）。
- **本番永続化**: Cloud Run本番環境は Cloud SQL(MySQL) を使用し、SQLiteローカルファイル依存を避ける。
- **AI運用性**: 画像生成用/設問生成用のシステムプロンプトを管理画面からYAML編集可能にする。
- **運用フィードバック収集**: Teacher/User・Admin/Ownerのログオフ時に、V2不具合報告・V3要望・その他コメントを回収できるようにする。

## 2. ユーザー種別
- Admin/Owner: User管理、運用管理。
- Teacher/User: クイズ作成（リッチデータ対応）、一覧確認、削除、QR 発行。
- Student: クイズ受験（穴埋め形式）、結果・詳細解説の確認。

## 3. 画面・機能要件
### 3.1 Teacher/User画面 `/admin` (新規または改修)
- 入力項目の大幅な追加（各問題に対して以下の設定が可能になること）
  - 設問文（`prompt`。例: "【この状況に合う言葉は？】"）
  - **穴埋め文**（`sentence`。例: "梅雨の時期、一日中（　　）と雨が降っている。"）
  - 選択肢（**V1の要件通り3つに固定**。1つが正解）
  - **正解の理由/解説**（`explanation`。後方互換で `why` も受理）
  - **他選択肢の解説**（`others`：他選択肢ごとの使用場面、例文）
  - 画像URL（任意）
- Teacher/User運用を考慮し、以下を満たすこと。
  - Googleログイン（教師アカウント限定）で管理画面に入れる
  - トップ（`/`）から「教師・管理者はこちら」→`/teacher-login` で認証する導線を提供する
  - `/teacher-login` はログイン前は認証ページ、ログイン済みOwnerには遷移先選択ページとして振る舞う
  - 認証後、Teacher/Userは`/admin`へ遷移し、Admin/Ownerは`/admin`と`/owner-admin`の選択ができる
  - 互換運用として `?token=` 付きURLによるトークン方式も利用できる
  - AI設定として、`画像生成用` と `設問生成用` のYAMLを個別に保存・再読込・初期化できる
  - 右上には、Googleプロフィール画像 + メールアドレスのアカウントチップを表示する
    - チップのメニューから `ログオフ` と `管理者画面へ`（Ownerのみ）を開ける
  - タイトル行に `編集中 / 保存済` ステータスを表示し、`新規作成` ボタンで次のクイズ作成へ移れる
  - `新規作成` 実行時は「現在編集中のタイトルと内容を破棄する」確認ダイアログを表示する
  - 既存タイトル保存時は `上書き保存` か `別名保存` を選べること（同名での新規保存は不可）
  - `編集を終了してホーム画面へ戻る` を提供し、未保存変更がある場合は確認ダイアログを表示する
  - 行削除は常に行を削除し、行数が5未満になった場合は空行を自動補充する
  - `サンプル問題を読み込む` ボタンは提供しない（運用導線を簡素化）
  - 設問AI生成時は、既入力値を維持しつつ空欄を補完する（選択肢重複は許容しない）
  - AIレート制限到達時は、赤いポップアップではなく画面内通知
    - `生成AIがちょっと疲れました。しばらくしてもう一度お試しください。`
  - 管理画面ではブロッキングな `alert` を使用せず、画面内メッセージで案内する
  - AI設定は初期表示を1行にし、対象（画像生成用/設問生成用）選択後にYAML編集画面を表示する
  - YAML編集画面の導線は `保存して編集を終了する` とする
  - 生成したQRコードの横に `QRコードをコピー` ボタンを表示する
  - 画像再生成は保存前のみ `前の画像に戻す` を提供し、保存後は戻し不可とする
  - 設問AI生成では、設問・穴埋め文・解説・不正解2語分の場面/例文に、N2〜N3レベルの平易で自然な日本語を使う
  - ログオフ時は `/teacher-signout` に遷移し、コメント入力画面を表示する

### 3.1.1 Admin/Owner画面 `/owner-admin`
- 1画面を左右2ペインに分割する
  - 左ペイン: Teacher/Userメールの追加・削除
  - 右ペイン: ログオフ時に投稿されたユーザー要望の一覧表示
- Ownerは `ログオフ` ボタンから、コメント入力付き終了画面へ遷移できる
- 要望一覧には以下を表示する
  - 投稿者メール（または匿名）
  - 投稿日時
  - `V2での不具合報告`
  - `バージョン3への要望事項`
  - `その他`

### 3.2 Student画面 `/quiz/[id]` (新規)
- **クイズ回答画面**
  - 進行状況バーの表示
  - 穴埋め問題UI（空欄 `(　　)` を含む文章の表示）
  - 問題画像は全体が見えること（上下トリミングしない）
    - `object-fit: contain` 相当で縦横比を保持し、表示領域に収める
- **詳細解説画面（Feedback Screen）**
  - 正解時の紙吹雪（Confetti）アニメーション
  - タブ切り替えUI（「正解理由」「他選択肢」の2タブ構成）
  - スケール図やアイコンを活用した視覚的な情報提示
- **結果画面（Results Screen）**
  - バッチまたは全体の終了時に、正解率、正解数、復習おすすめ単語を表示する。
  - 操作ボタンは `もう一度挑戦` `ホームへ戻る` `終了` の3つを同サイズ横並びで表示する
  - `終了` は「また明日も頑張りましょう！学習セッションを終了しました」を表示する終了画面へ遷移する
- **下部ナビゲーション（将来機能）**
  - `ホーム/図鑑/進捗/設定` は現時点で遷移を持たず、押下時に画面内トースト `工事中` を表示する
- **トップページ `/`**
  - 「QRからアクセスしてください」を明示する説明ページとして表示する
  - `?quiz=<id>` が付与される場合のみ、名前入力と開始導線を表示する
- **Teacher/User・Admin/Owner 終了画面 `/teacher-signout`**
  - ログオフ完了後の画面として表示する
  - `V2での不具合報告` `バージョン3への要望事項` `その他` の3入力欄を表示する
  - コメント送信後は `user_feedback` に保存する
  - 戻り導線は `ホーム画面へ戻る` とする

## 4. データ要件（スキーマ定義案）
SQLiteの `quizzes` テーブル（`id`, `title`, `questions_json`, `created_at`）は変更せず、`questions_json` 内のオブジェクト構造を以下に拡張する。

```json
{
  "id": "uuid",
  "imageUrl": "https://...",
  "prompt": "設問文",
  "sentence": "穴埋め用例文（　　）付き",
  "correctIndex": 0,
  "choices": ["しとしと", "ざあざあ", "ぽつぽつ"],
  "explanation": "正解理由テキスト",
  "others": [
    { "word": "ざあざあ", "usage": "大雨", "example": "「雨がざあざあ降る」" },
    { "word": "ぽつぽつ", "usage": "降り始め", "example": "「雨がぽつぽつ降る」" }
  ]
}
```

補足:
- APIは後方互換のため `question` / `why` / `image` も受理するが、保存時は `prompt` / `explanation` / `imageUrl` を正規形とする。
- プロンプト設定は `prompt_configs(type, yaml_text, updated_at)` に保存し、`type` は `question` / `image` を採用する。
- Admin/OwnerとTeacher/Userアカウントは `admin_users(email, created_at, created_by)` と固定Owner設定で管理する。
- ログオフ時コメントは `user_feedback(submitted_by, bug_report, v3_request, other_comment, created_at)` に保存する。
- Studentは現行仕様では内部IDを保持せず、`learner_name`（表示名）をクイズログ単位で保存する。
  - 学習者の学習履歴IDはV2では保持しない（V3検討項目）。

## 5. UI/UX 要件
- レスポンシブ対応: 学習者向けはスマホネイティブアプリ風のUI（`width: 100vw; height: 100vh` ベース）、管理画面はPC/タブレット操作に適したUIとする。
- アンドロイド・iOS双方のWebブラウザでのタップ操作を意識し、アニメーション（CSS `transition` / `keyframes`）を活用する。
- セキュリティ要件:
  - ユーザー入力値を `innerHTML` へ直接注入しない（XSS対策）
  - 管理系APIは `Authorization: Bearer <token>` を必須化（Google IDトークンまたは管理トークン）
  - AI系・画像アップロードAPIは簡易レート制限を適用
- 運用要件:
  - 教師向けにGoogleログイン運用を提供できること
  - Teacher/User・Admin/Ownerは、ログオフ後に運用コメントを残せること
  - 管理画面セッションはローカル保持＋サイレント再認証で最低3時間維持すること
  - 教師向け簡易マニュアル（1ページ）を提供すること
  - 最低限のE2Eスモーク（管理画面アクセス・学習者開始）を継続実行できること
  - AI呼び出し制限（レートリミット）:
    - 設問生成: 60秒あたり最大60回（最低30回を下限保証）
    - 画像生成: 60秒あたり最大20回
    - 上限到達時は429を返すが、画面では穏やかな案内文を表示する

## 6. 受け入れ基準
- Teacher/User画面で、V2用の追加情報（穴埋め文、タブ用解説等）を含めたクイズが作成・保存できること。
- 保存したクイズをStudent画面で開き、V2の新しいUIレイアウトで問題が解けること。
- 選択肢はV1の要件を引き継ぎ、常に3つで出題されること。
- クイズ終了時、詳細な結果画面が表示されること。
- 管理APIに未認証でアクセスした場合は `401`、認証済みなら正常応答すること。
- StudentはQR配布導線（`/quiz/:id`）で利用でき、トップ（`/`）から用途が誤解されないこと。
- 設問AI生成で、既入力の選択肢・正解・解説と矛盾する内容を新規生成しないこと。
- 設問AI生成で、設問・穴埋め文・解説・不正解2語分の場面/例文が、N2〜N3レベルの平易な日本語になること。
- 設問AI/画像AIの上限到達時、赤枠エラーやブラウザポップアップではなく画面内通知で案内されること。
- `/owner-admin` で、教師アカウント管理とユーザー要望表示が左右分割で確認できること。
