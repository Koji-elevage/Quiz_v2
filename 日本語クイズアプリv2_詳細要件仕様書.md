# 日本語クイズアプリ v2 詳細要件仕様書

最終更新日: 2026-02-24
対象: 授業連動型語学クイズアプリ「日本語クイズ」 v2 アップデート

## 0. 役割定義
- `Admin = Owner`: システム管理権限（User追加/削除）
- `Teacher = User`: 問題作成・編集・配布
- `Student`: クイズ受験者

## 1. 目的とスコープ
- 学習者のモチベーション向上を目的に、進捗バー、クリア時のアニメーション（紙吹雪など）を導入する。
- **データ構造の拡張**: UIの充実に伴い、DBに保存するJSON構造（`questions_json`）を拡張する。
- **アーキテクチャの分離**: V2のプロトタイプUI（1ファイル）を、V1同様に「Teacher/User画面」「Student画面」「サーバー/DB」に分割・統合する。
- **運用導線の明確化**: Studentの正規導線は「Teacher/User配布のQR（`/quiz/:id`）」とし、トップ（`/`）は説明ページとして扱う。
- **管理系保護**: 管理系APIはAdmin/OwnerまたはTeacher/User認証を必須にする（既定はGoogleログイン、互換としてトークン方式も可）。
- **本番永続化**: Cloud Run本番環境は Cloud SQL(MySQL) を使用し、SQLiteローカルファイル依存を避ける。
- **AI運用性**: 画像生成用/設問生成用のシステムプロンプトを管理画面からYAML編集可能にする。

## 2. ユーザー種別
- Admin/Owner: User管理、運用管理。
- Teacher/User: クイズ作成（リッチデータ対応）、一覧確認、削除、QR 発行。
- Student: クイズ受験（穴埋め形式）、結果・詳細解説の確認。

## 3. 画面・機能要件
### 3.1 Teacher/User画面 `/admin` (新規または改修)
- 入力項目の大幅な追加（各問題に対して以下の設定が可能になること）
  - 設問文（`prompt`。例: "【この状況に合う言葉は？】"）
  - **穴埋め文**（`sentence`。例: "梅雨の時期、一日中（　　）と雨が降っている。"）
  - 選択肢（**V1の要件通り3つに固定**。1つが正解）
  - **正解の理由/解説**（`explanation`。後方互換で `why` も受理）
  - **他選択肢の解説**（`others`：他選択肢ごとの使用場面、例文）
  - 画像URL（任意）
- Teacher/User運用を考慮し、以下を満たすこと。
  - Googleログイン（教師アカウント限定）で管理画面に入れる
  - トップ（`/`）から「Teacher / User・Admin / Ownerはこちら」→`/teacher-login` で認証する導線を提供する
  - 認証後、Teacher/Userは`/admin`へ遷移し、Admin/Ownerは`/admin`と`/owner-admin`の選択ができる
  - 互換運用として `?token=` 付きURLによるトークン方式も利用できる
  - AI設定として、`画像生成用` と `設問生成用` のYAMLを個別に保存・再読込・初期化できる
  - LP（`/`）でオーナーが教師アカウント（管理者）を追加・削除できる

### 3.2 Student画面 `/quiz/[id]` (新規)
- **クイズ回答画面**
  - 進行状況バーの表示
  - 穴埋め問題UI（空欄 `(　　)` を含む文章の表示）
- **詳細解説画面（Feedback Screen）**
  - 正解時の紙吹雪（Confetti）アニメーション
  - タブ切り替えUI（「正解理由」「他選択肢」の2タブ構成）
  - スケール図やアイコンを活用した視覚的な情報提示
- **結果画面（Results Screen）**
  - バッチまたは全体の終了時に、正解率、正解数、復習おすすめ単語を表示する。
- **トップページ `/`**
  - 「QRからアクセスしてください」を明示する説明ページとして表示する
  - `?quiz=<id>` が付与される場合のみ、名前入力と開始導線を表示する

## 4. データ要件（スキーマ定義案）
SQLiteの `quizzes` テーブル（`id`, `title`, `questions_json`, `created_at`）は変更せず、`questions_json` 内のオブジェクト構造を以下に拡張する。

```json
{
  "id": "uuid",
  "imageUrl": "https://...",
  "prompt": "設問文",
  "sentence": "穴埋め用例文（　　）付き",
  "correctIndex": 0,
  "choices": ["しとしと", "ざあざあ", "ぽつぽつ"],
  "explanation": "正解理由テキスト",
  "others": [
    { "word": "ざあざあ", "usage": "大雨", "example": "「雨がざあざあ降る」" },
    { "word": "ぽつぽつ", "usage": "降り始め", "example": "「雨がぽつぽつ降る」" }
  ]
}
```

補足:
- APIは後方互換のため `question` / `why` / `image` も受理するが、保存時は `prompt` / `explanation` / `imageUrl` を正規形とする。
- プロンプト設定は `prompt_configs(type, yaml_text, updated_at)` に保存し、`type` は `question` / `image` を採用する。
- Admin/OwnerとTeacher/Userアカウントは `admin_users(email, created_at, created_by)` と固定Owner設定で管理する。
- Studentは現行仕様では内部IDを保持せず、`learner_name`（表示名）をクイズログ単位で保存する。

## 5. UI/UX 要件
- レスポンシブ対応: 学習者向けはスマホネイティブアプリ風のUI（`width: 100vw; height: 100vh` ベース）、管理画面はPC/タブレット操作に適したUIとする。
- アンドロイド・iOS双方のWebブラウザでのタップ操作を意識し、アニメーション（CSS `transition` / `keyframes`）を活用する。
- セキュリティ要件:
  - ユーザー入力値を `innerHTML` へ直接注入しない（XSS対策）
  - 管理系APIは `Authorization: Bearer <token>` を必須化（Google IDトークンまたは管理トークン）
  - AI系・画像アップロードAPIは簡易レート制限を適用
- 運用要件:
  - 教師向けにGoogleログイン運用を提供できること
  - 教師向け簡易マニュアル（1ページ）を提供すること
  - 最低限のE2Eスモーク（管理画面アクセス・学習者開始）を継続実行できること

## 6. 受け入れ基準
- Teacher/User画面で、V2用の追加情報（穴埋め文、タブ用解説等）を含めたクイズが作成・保存できること。
- 保存したクイズをStudent画面で開き、V2の新しいUIレイアウトで問題が解けること。
- 選択肢はV1の要件を引き継ぎ、常に3つで出題されること。
- クイズ終了時、詳細な結果画面が表示されること。
- 管理APIに未認証でアクセスした場合は `401`、認証済みなら正常応答すること。
- StudentはQR配布導線（`/quiz/:id`）で利用でき、トップ（`/`）から用途が誤解されないこと。
