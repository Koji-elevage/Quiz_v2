# 日本語クイズアプリ v2 実装手順書

最終更新日: 2026-02-24
対象: 「日本語クイズ」 v2 （UI/UX のリッチ化・統合）

## 1. 実装方針
- V2で制作した単一のHTMLプロトタイプ（`Onomatope_Quiz_v2.html`）を「UI/UX用リソース」として扱い、V1と同様の「管理者画面（登録）」「サーバー/DB（保存）」「学習者画面（出題）」の3層構造に分離・再構成する。
- 既存のDBテーブル構成（`quizzes`）は維持し、格納するJSONのデータ構造（`questions_json`）のみアップグレードする。
- **選択肢数はV1の要件通り3つに制限**しつつ、V2で追加された新規項目（穴埋めテキスト、他選択肢の解説など）をAPIで送受信できるようにする。
- 学習者導線は「管理者が発行したQR（`/quiz/:id`）」を正規ルートとする。トップ（`/`）は説明ページとして扱う。
- 管理系APIは `ADMIN_TOKEN` による認証を必須化する（学習者APIは公開）。

## 2. 実装ステップ
### Step 1: バックエンド（`server.js`等）の改修
- **エンドポイント準備**: `public/quiz.html`, `public/admin.html` などを配信できるようにルーティングを調整。
- **データモデルの更新**: 保存API（`POST /api/quizzes`, `PUT /api/quizzes/:id`）における入力バリデーション（`normalizeQuestion`）をV2用に強化する。
  - 新規フィールド（`sentence`, `explanation`, `others`）を受け取れるように改修（後方互換として `why` も受理）。
  - `choices`（選択肢）のバリデーションを「4」ではなく「3（V1要件）」に設定する。
- **セキュリティ対応**:
  - 管理系エンドポイント（クイズ一覧/保存/更新/削除、ログ閲覧、AI生成、画像アップロード）に `Bearer <ADMIN_TOKEN>` 認証を適用。
  - AI系API・画像アップロードAPIに簡易レート制限を実装。
  - Cloud Run起動時の安定化として、`db/` ディレクトリを起動時に自動作成する。

### Step 2: フロントエンド（学習者画面 `/quiz/[id]`）の再構築
- `Onomatope_Quiz_v2.html` から、CSS（`<style>`）を `public/styles.css` として別ファイルに切り出す。
- UIのHTML部分（`.phone-frame` など）を `public/quiz.html` として整える。PCブラウザでの表示だけでなく、スマホ実機で全画面表示されるようにレスポンシブ化（`width: 100vw; height: 100vh;`等）を適用する。
- JavaScriptロジックを `public/quiz.js` として別ファイルにする。
  - ハードコードされているモックデータ（`const questions = [...]`）を削除。
  - 初期化時に `fetch('/api/quizzes/' + quizId)` でDBからJSONデータを取得して UI をレンダリングする処理（マッピング）を実装する。
- XSS対策として、学習者画面では `innerHTML` でのユーザー入力文字列注入を避け、`textContent` / `createElement` 中心で描画する。
- 結果ログ送信時の正解数は固定値ではなく、実計算値（`firstTryCorrect`）を送る。

### Step 3: フロントエンド（管理者用画面 `/admin`）の刷新
- 新しい管理画面 `public/admin.html` および `public/admin.js` を作成。
- JSON構造の変更に合わせて、V1よりも拡張された入力フォーム（穴埋め文章、他選択肢の意味、2つのタブ用コンテンツなど）を作成する。
- 新規フィールド群を一つのJSONオブジェクトに構築し、`POST /api/quizzes` への送信処理を実装する。
- 入力項目が多いアコーディオンUIなどを想定し、管理者が登録しやすいUIに工夫する。
- 管理画面は `Authorization` ヘッダーを付与して管理系APIへアクセスする。
- 初回オンボーディングを簡素化するため、以下を実装する。
  - `?token=` / `?adminToken=` 付きURLからトークンを自動保存
  - 固定フォールバックトークンを自動適用（入力ダイアログを極力出さない）
- クリップボード貼り付け処理の改行正規化（`\r\n` / `\r`）を修正する。
- 管理画面のログ一覧・クイズ一覧描画でも、XSS対策として文字列を安全に描画する。

### Step 4: 動作確認・QA
- 管理者画面で「すべて入力して保存できること」と「必須項目エラー（選択肢3つなど）が正しく弾かれること」を確認。
- 発行されたQRコードまたはURLで学習者画面（`/quiz/[id]`）を開き、入力した「穴埋め文章」や「解説タブ（2種類）」が正しく反映されているかを確認。
- 正解時（紙吹雪など）／不正解時（正しい選択肢の強調など）のアニメーションが正確に発火するかをテスト。
- 管理画面APIが「未認証: 401」「認証あり: 200」で動作することを確認。
- `/` はQR利用の説明ページとして表示され、`/quiz/:id` が学習者の主導線になっていることを確認。

## 3. テストシナリオ
### 3.1 サーバー/DB動作
- 選択肢が3つ未満または4つ以上の場合に、登録API（`POST /api/quizzes`）が 400 エラーを返すこと。
- 全ての任意・必須新規項目（`others` など）を含んだJSONが欠落なくDBに保存され、取得用API（`GET /api/quizzes/:id`）で同じ構造が返却されること。

### 3.2 管理者画面（V2）
- 複雑になった各問題の入力フォームで、新規問題の追加や削除ができること。
- 入力途中でも画面がスクロールなどで崩れず、各項目の編集がスムーズに行えること。
- 「保存してURL発行」ボタンが正常に動作し、QRコードが生成されること。

### 3.3 学習者画面（V2）
- 取得したJSONデータに基づいて、進行状況バー、穴埋め文章が表示されること。
- 選択肢（3択）を選択後、正解・不正解に応じたアニメーションと解説画面（Feedback Screen）へ正しく遷移すること。
- 解説画面の「正解理由」「類義語（他の選択肢）」の2タブが正常に切り替わり、DB由来の文字が表示されること。
- バッチ終了時（結果画面）に正解率と正解数が計算され、復習おすすめ単語が表示されること。

## 4. 完了条件
- 管理者画面から新しいフォーマットのJSONを入力・保存できる。
- 保存されたデータを利用し、V2学習者画面でエラーなくクイズを完了できる。
- V2の新しいデザイン・演出（CSS/アニメーション）が本番環境で担保されていること。
- Cloud Run上で管理API認証を有効化した状態で稼働し、教師ユーザーが入力ダイアログなしで管理画面操作できること。
