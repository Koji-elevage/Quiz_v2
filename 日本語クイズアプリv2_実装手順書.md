# 日本語クイズアプリ v2 実装手順書

最終更新日: 2026-03-01
対象: 「日本語クイズ」 v2 （UI/UX のリッチ化・統合）

## 0. 役割定義
- `Admin = Owner`: システム管理権限（User追加/削除）
- `Teacher = User`: 問題作成・編集・配布
- `Student`: クイズ受験者

## 1. 実装方針
- V2で制作した単一のHTMLプロトタイプ（`Onomatope_Quiz_v2.html`）を「UI/UX用リソース」として扱い、V1と同様の「Teacher/User画面（登録）」「サーバー/DB（保存）」「Student画面（出題）」の3層構造に分離・再構成する。
- 既存のDBテーブル構成（`quizzes`）は維持し、格納するJSONのデータ構造（`questions_json`）のみアップグレードする。
- **選択肢数はV1の要件通り3つに制限**しつつ、V2で追加された新規項目（穴埋めテキスト、他選択肢の解説など）をAPIで送受信できるようにする。
- Student導線は「Teacher/Userが発行したQR（`/quiz/:id`）」を正規ルートとする。トップ（`/`）は説明ページとして扱う。
- 管理系APIはTeacher/UserまたはAdmin/Owner認証を必須化する（既定はGoogleログイン、Student APIは公開）。

## 2. 実装ステップ
### Step 1: バックエンド（`server.js`等）の改修
- **エンドポイント準備**: `public/quiz.html`, `public/admin.html` などを配信できるようにルーティングを調整。
- **データモデルの更新**: 保存API（`POST /api/quizzes`, `PUT /api/quizzes/:id`）における入力バリデーション（`normalizeQuestion`）をV2用に強化する。
  - 新規フィールド（`sentence`, `explanation`, `others`）を受け取れるように改修（後方互換として `why` も受理）。
  - `choices`（選択肢）のバリデーションを「4」ではなく「3（V1要件）」に設定する。
- **セキュリティ対応**:
  - 管理系エンドポイント（クイズ一覧/保存/更新/削除、ログ閲覧、AI生成、画像アップロード）に `Bearer` 認証を適用。
  - `ADMIN_AUTH_MODE=google` 時は Google IDトークンを検証し、許可メール/ドメインをチェックする。
  - AI系API・画像アップロードAPIに簡易レート制限を実装。
  - Cloud Run起動時の安定化として、`db/` ディレクトリを起動時に自動作成する。
- **永続化対応（本番）**:
  - Cloud Run 本番環境では `DB_DRIVER=mysql` を用いて Cloud SQL(MySQL) を利用する。
  - Cloud SQL接続は `run.googleapis.com/cloudsql-instances` を設定し、`roles/cloudsql.client` を付与したサービスアカウントで行う。
- **AIプロンプト設定対応**:
  - `prompt_configs(type, yaml_text, updated_at)` テーブルを追加し、`question` / `image` のYAMLを保存可能にする。
  - `GET /api/prompt-configs`, `PUT /api/prompt-configs/:type`, `POST /api/prompt-configs/:type/reset` を管理者認証付きで提供する。
- **管理者ユーザー管理対応**:
  - `admin_users(email, created_at, created_by)` テーブルを追加し、LPから教師アカウントを追加できるようにする。
  - `GET /api/admin-users`, `POST /api/admin-users`, `DELETE /api/admin-users/:email` をオーナー専用APIとして提供する。
  - `GET /api/auth/session` を追加し、認証済みユーザーの役割（owner/user）を返す。
- **運用フィードバック対応**:
  - `user_feedback(submitted_by, bug_report, v3_request, other_comment, created_at)` テーブルを追加する。
  - `POST /api/feedback` でログオフ後コメントを保存できるようにする。
  - `GET /api/feedback` をオーナー専用APIとして提供し、管理者画面に表示する。

### Step 2: フロントエンド（Student画面 `/quiz/[id]`）の再構築
- `Onomatope_Quiz_v2.html` から、CSS（`<style>`）を `public/styles.css` として別ファイルに切り出す。
- UIのHTML部分（`.phone-frame` など）を `public/quiz.html` として整える。PCブラウザでの表示だけでなく、スマホ実機で全画面表示されるようにレスポンシブ化（`width: 100vw; height: 100vh;`等）を適用する。
- JavaScriptロジックを `public/quiz.js` として別ファイルにする。
  - ハードコードされているモックデータ（`const questions = [...]`）を削除。
  - 初期化時に `fetch('/api/quizzes/' + quizId)` でDBからJSONデータを取得して UI をレンダリングする処理（マッピング）を実装する。
- XSS対策として、Student画面では `innerHTML` でのユーザー入力文字列注入を避け、`textContent` / `createElement` 中心で描画する。
- 結果ログ送信時の正解数は固定値ではなく、実計算値（`firstTryCorrect`）を送る。

### Step 3: フロントエンド（Teacher/User画面 `/admin`）の刷新
- 新しい管理画面 `public/admin.html` および `public/admin.js` を作成。
- JSON構造の変更に合わせて、V1よりも拡張された入力フォーム（穴埋め文章、他選択肢の意味、2つのタブ用コンテンツなど）を作成する。
- 新規フィールド群を一つのJSONオブジェクトに構築し、`POST /api/quizzes` への送信処理を実装する。
- Teacher/Userが登録しやすいよう、表計算ライクな1画面編集UIを維持する。
- 管理画面は `Authorization` ヘッダーを付与して管理系APIへアクセスする。
- 初回オンボーディングを簡素化するため、以下を実装する。
  - Googleログインは One Tap ではなく、明示的な Google公式ボタンで実行する
  - 互換モードとして `?token=` / `?adminToken=` 付きURLからトークン自動保存も維持
- クリップボード貼り付け処理の改行正規化（`\r\n` / `\r`）を修正する。
- 管理画面のログ一覧・クイズ一覧描画でも、XSS対策として文字列を安全に描画する。
- 管理画面に「AI設定（YAML）」セクションを追加し、初期表示は1行（説明+対象選択）とし、選択後に編集画面を表示する。
- YAML編集画面は `保存して編集を終了する` 導線に統一する。
- LPには管理機能を直接出さず、「教師・管理者はこちら」→`/teacher-login`でGoogleログインする導線にする。
- `/teacher-login`は、ログイン前は認証ページ、ログイン済みOwnerには遷移先選択ページとして使う。
- `/teacher-login`で、Teacher/Userは`/admin`へ、Admin/Ownerは`/admin`または`/owner-admin`へ分岐する。
- `/owner-admin`は左右2ペイン構成とし、左でTeacher/Userメール管理、右でユーザー要望表示を行う。
- `/teacher-signout` を追加し、ログオフ完了とコメント送信画面として使う。
- タイトル行に `編集中/保存済` の状態表示と `新規作成` を実装する。
- 既存タイトル保存時は `上書き保存` / `別名保存` の選択フローを実装する。
- `編集を終了してホーム画面へ戻る` を実装し、未保存変更時は確認ダイアログを表示する。
- 行削除後は最小5行を下回らないよう空行を自動補充する。
- QRコード表示時に `QRコードをコピー` を提供する。
- 画像再生成は保存前のみ `前の画像に戻す` を提供する。
- 管理画面の通知はブラウザ `alert` ではなく画面内メッセージを基本とする。
- `/admin` 右上は、ログイン前はGoogleログインボタン、ログイン後はプロフィール画像+メールのアカウントチップに切り替える。
- アカウントチップのメニューに `ログオフ` と `管理者画面へ`（Ownerのみ）を実装する。
- 設問生成プロンプトには、N2〜N3レベルの平易な日本語を使う制約を含める。

### Step 4: 動作確認・QA
- Teacher/User画面で「すべて入力して保存できること」と「必須項目エラー（選択肢3つなど）が正しく弾かれること」を確認。
- 発行されたQRコードまたはURLでStudent画面（`/quiz/[id]`）を開き、入力した「穴埋め文章」や「解説タブ（2種類）」が正しく反映されているかを確認。
- 正解時（紙吹雪など）／不正解時（正しい選択肢の強調など）のアニメーションが正確に発火するかをテスト。
- 管理画面APIが「未認証: 401」「認証あり: 200」で動作することを確認。
- AI設定APIで、YAMLの取得・保存・初期化が正常に動作することを確認。
- 保存済み設問生成YAMLとコード側フォールバックの両方に、N2〜N3レベルの平易な日本語制約が反映されていることを確認。
- `/` はQR利用の説明ページとして表示され、`/quiz/:id` がStudentの主導線になっていることを確認。
- `npm run test:e2e`（Playwrightスモーク）で、Teacher/User画面アクセスとStudent開始導線が通ることを確認。
- AIレート制限（設問60/min、画像20/min）到達時、`429` とともに画面内で穏やかな案内文が表示されることを確認。
- 管理画面セッションがローカル保持+サイレント再認証で3時間維持されることを確認。
- データ移行スクリプト（`npm run migrate:to-cloud`）は通常デプロイに組み込まず、初期投入など必要時のみ手動実行することを確認。

## 3. テストシナリオ
### 3.1 サーバー/DB動作
- 選択肢が3つ未満または4つ以上の場合に、登録API（`POST /api/quizzes`）が 400 エラーを返すこと。
- 全ての任意・必須新規項目（`others` など）を含んだJSONが欠落なくDBに保存され、取得用API（`GET /api/quizzes/:id`）で同じ構造が返却されること。

### 3.2 Teacher/User画面（V2）
- 複雑になった各問題の入力フォームで、新規問題の追加や削除ができること。
- 入力途中でも画面がスクロールなどで崩れず、各項目の編集がスムーズに行えること。
- 「保存してURL発行」ボタンが正常に動作し、QRコードが生成されること。
- 既存タイトル編集後の保存で、`上書き`/`別名` が正しく分岐すること。
- `編集を終了してホーム画面へ戻る` で未保存時に確認が出ること。
- 画像再生成後、保存前のみ `前の画像に戻す` が機能すること。
- 右上アカウントチップからログオフでき、`/teacher-signout` に遷移すること。
- `/teacher-signout` でコメント送信後、`/owner-admin` 右ペインに表示されること。

### 3.3 Student画面（V2）
- 取得したJSONデータに基づいて、進行状況バー、穴埋め文章が表示されること。
- 選択肢（3択）を選択後、正解・不正解に応じたアニメーションと解説画面（Feedback Screen）へ正しく遷移すること。
- 解説画面の「正解理由」「類義語（他の選択肢）」の2タブが正常に切り替わり、DB由来の文字が表示されること。
- バッチ終了時（結果画面）に正解率と正解数が計算され、復習おすすめ単語が表示されること。
- 問題画像が `object-fit: contain` 相当で上下欠けなく表示されること。
- 下部ナビゲーションの未実装項目押下時に、画面内トースト `工事中` が表示されること。
- 結果画面の `終了` で終了メッセージ画面に遷移すること。

## 4. 完了条件
- Teacher/User画面から新しいフォーマットのJSONを入力・保存できる。
- 保存されたデータを利用し、V2 Student画面でエラーなくクイズを完了できる。
- V2の新しいデザイン・演出（CSS/アニメーション）が本番環境で担保されていること。
- Cloud Run上で管理API認証を有効化した状態で稼働し、Teacher/Userが入力ダイアログなしで管理画面操作できること。
- Cloud Run上で Cloud SQL(MySQL) を利用し、リビジョン更新後もクイズデータが保持されること。
- Cloud Run上で、Ownerが教師追加とユーザー要望確認を1画面で実施できること。
