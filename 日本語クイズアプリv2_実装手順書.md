# 日本語クイズアプリ v2 実装手順書

最終更新日: 2026-02-24
対象: 「日本語クイズ」 v2 （UI/UX のリッチ化・統合）

## 0. 役割定義
- `Admin = Owner`: システム管理権限（User追加/削除）
- `Teacher = User`: 問題作成・編集・配布
- `Student`: クイズ受験者

## 1. 実装方針
- V2で制作した単一のHTMLプロトタイプ（`Onomatope_Quiz_v2.html`）を「UI/UX用リソース」として扱い、V1と同様の「Teacher/User画面（登録）」「サーバー/DB（保存）」「Student画面（出題）」の3層構造に分離・再構成する。
- 既存のDBテーブル構成（`quizzes`）は維持し、格納するJSONのデータ構造（`questions_json`）のみアップグレードする。
- **選択肢数はV1の要件通り3つに制限**しつつ、V2で追加された新規項目（穴埋めテキスト、他選択肢の解説など）をAPIで送受信できるようにする。
- Student導線は「Teacher/Userが発行したQR（`/quiz/:id`）」を正規ルートとする。トップ（`/`）は説明ページとして扱う。
- 管理系APIはTeacher/UserまたはAdmin/Owner認証を必須化する（既定はGoogleログイン、Student APIは公開）。

## 2. 実装ステップ
### Step 1: バックエンド（`server.js`等）の改修
- **エンドポイント準備**: `public/quiz.html`, `public/admin.html` などを配信できるようにルーティングを調整。
- **データモデルの更新**: 保存API（`POST /api/quizzes`, `PUT /api/quizzes/:id`）における入力バリデーション（`normalizeQuestion`）をV2用に強化する。
  - 新規フィールド（`sentence`, `explanation`, `others`）を受け取れるように改修（後方互換として `why` も受理）。
  - `choices`（選択肢）のバリデーションを「4」ではなく「3（V1要件）」に設定する。
- **セキュリティ対応**:
  - 管理系エンドポイント（クイズ一覧/保存/更新/削除、ログ閲覧、AI生成、画像アップロード）に `Bearer` 認証を適用。
  - `ADMIN_AUTH_MODE=google` 時は Google IDトークンを検証し、許可メール/ドメインをチェックする。
  - AI系API・画像アップロードAPIに簡易レート制限を実装。
  - Cloud Run起動時の安定化として、`db/` ディレクトリを起動時に自動作成する。
- **永続化対応（本番）**:
  - Cloud Run 本番環境では `DB_DRIVER=mysql` を用いて Cloud SQL(MySQL) を利用する。
  - Cloud SQL接続は `run.googleapis.com/cloudsql-instances` を設定し、`roles/cloudsql.client` を付与したサービスアカウントで行う。
- **AIプロンプト設定対応**:
  - `prompt_configs(type, yaml_text, updated_at)` テーブルを追加し、`question` / `image` のYAMLを保存可能にする。
  - `GET /api/prompt-configs`, `PUT /api/prompt-configs/:type`, `POST /api/prompt-configs/:type/reset` を管理者認証付きで提供する。
- **管理者ユーザー管理対応**:
  - `admin_users(email, created_at, created_by)` テーブルを追加し、LPから教師アカウントを追加できるようにする。
  - `GET /api/admin-users`, `POST /api/admin-users`, `DELETE /api/admin-users/:email` をオーナー専用APIとして提供する。
  - `GET /api/auth/session` を追加し、認証済みユーザーの役割（owner/user）を返す。

### Step 2: フロントエンド（Student画面 `/quiz/[id]`）の再構築
- `Onomatope_Quiz_v2.html` から、CSS（`<style>`）を `public/styles.css` として別ファイルに切り出す。
- UIのHTML部分（`.phone-frame` など）を `public/quiz.html` として整える。PCブラウザでの表示だけでなく、スマホ実機で全画面表示されるようにレスポンシブ化（`width: 100vw; height: 100vh;`等）を適用する。
- JavaScriptロジックを `public/quiz.js` として別ファイルにする。
  - ハードコードされているモックデータ（`const questions = [...]`）を削除。
  - 初期化時に `fetch('/api/quizzes/' + quizId)` でDBからJSONデータを取得して UI をレンダリングする処理（マッピング）を実装する。
- XSS対策として、Student画面では `innerHTML` でのユーザー入力文字列注入を避け、`textContent` / `createElement` 中心で描画する。
- 結果ログ送信時の正解数は固定値ではなく、実計算値（`firstTryCorrect`）を送る。

### Step 3: フロントエンド（Teacher/User画面 `/admin`）の刷新
- 新しい管理画面 `public/admin.html` および `public/admin.js` を作成。
- JSON構造の変更に合わせて、V1よりも拡張された入力フォーム（穴埋め文章、他選択肢の意味、2つのタブ用コンテンツなど）を作成する。
- 新規フィールド群を一つのJSONオブジェクトに構築し、`POST /api/quizzes` への送信処理を実装する。
- 入力項目が多いアコーディオンUIなどを想定し、Teacher/Userが登録しやすいUIに工夫する。
- 管理画面は `Authorization` ヘッダーを付与して管理系APIへアクセスする。
- 初回オンボーディングを簡素化するため、以下を実装する。
  - GoogleログインボタンからTeacher/User・Admin/Ownerログインを実行
  - 互換モードとして `?token=` / `?adminToken=` 付きURLからトークン自動保存も維持
- クリップボード貼り付け処理の改行正規化（`\r\n` / `\r`）を修正する。
- 管理画面のログ一覧・クイズ一覧描画でも、XSS対策として文字列を安全に描画する。
- 管理画面に「AI設定（YAML）」セクションを追加し、画像生成用/設問生成用を切替保存できるようにする。
- LPには管理機能を直接出さず、「Teacher / User・Admin / Ownerはこちら」→`/teacher-login`でGoogleログインする導線にする。
- `/teacher-login`で、Teacher/Userは`/admin`へ、Admin/Ownerは`/admin`または`/owner-admin`へ分岐する。
- `/owner-admin`でTeacher/Userメールの追加/削除を行う。

### Step 4: 動作確認・QA
- Teacher/User画面で「すべて入力して保存できること」と「必須項目エラー（選択肢3つなど）が正しく弾かれること」を確認。
- 発行されたQRコードまたはURLでStudent画面（`/quiz/[id]`）を開き、入力した「穴埋め文章」や「解説タブ（2種類）」が正しく反映されているかを確認。
- 正解時（紙吹雪など）／不正解時（正しい選択肢の強調など）のアニメーションが正確に発火するかをテスト。
- 管理画面APIが「未認証: 401」「認証あり: 200」で動作することを確認。
- AI設定APIで、YAMLの取得・保存・初期化が正常に動作することを確認。
- `/` はQR利用の説明ページとして表示され、`/quiz/:id` がStudentの主導線になっていることを確認。
- `npm run test:e2e`（Playwrightスモーク）で、Teacher/User画面アクセスとStudent開始導線が通ることを確認。

## 3. テストシナリオ
### 3.1 サーバー/DB動作
- 選択肢が3つ未満または4つ以上の場合に、登録API（`POST /api/quizzes`）が 400 エラーを返すこと。
- 全ての任意・必須新規項目（`others` など）を含んだJSONが欠落なくDBに保存され、取得用API（`GET /api/quizzes/:id`）で同じ構造が返却されること。

### 3.2 Teacher/User画面（V2）
- 複雑になった各問題の入力フォームで、新規問題の追加や削除ができること。
- 入力途中でも画面がスクロールなどで崩れず、各項目の編集がスムーズに行えること。
- 「保存してURL発行」ボタンが正常に動作し、QRコードが生成されること。

### 3.3 Student画面（V2）
- 取得したJSONデータに基づいて、進行状況バー、穴埋め文章が表示されること。
- 選択肢（3択）を選択後、正解・不正解に応じたアニメーションと解説画面（Feedback Screen）へ正しく遷移すること。
- 解説画面の「正解理由」「類義語（他の選択肢）」の2タブが正常に切り替わり、DB由来の文字が表示されること。
- バッチ終了時（結果画面）に正解率と正解数が計算され、復習おすすめ単語が表示されること。

## 4. 完了条件
- Teacher/User画面から新しいフォーマットのJSONを入力・保存できる。
- 保存されたデータを利用し、V2 Student画面でエラーなくクイズを完了できる。
- V2の新しいデザイン・演出（CSS/アニメーション）が本番環境で担保されていること。
- Cloud Run上で管理API認証を有効化した状態で稼働し、Teacher/Userが入力ダイアログなしで管理画面操作できること。
- Cloud Run上で Cloud SQL(MySQL) を利用し、リビジョン更新後もクイズデータが保持されること。
